<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/defaultLayout}">

<th:block layout:fragment="css">
    <link rel="stylesheet" href="/css/insite/insite.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</th:block>
<th:block layout:fragment="script">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>

        document.addEventListener('DOMContentLoaded', () => {

            const leftCtx = document.getElementById('barChartLeft').getContext('2d');
            const rightCtx = document.getElementById('barChartRight').getContext('2d');

            let leftChart;
            let rightChart;

            function renderLeftChart(months, amounts) {

                if (leftChart) leftChart.destroy();
                leftChart = new Chart(leftCtx, {
                    type: 'bar',
                    data: {
                        labels: months.map(m => `${m}ì›”`),
                        datasets: [{
                            label: 'ì´ ì†Œë¹„',
                            data: amounts,
                            backgroundColor: '#3340cb'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: ctx => `${ctx.raw.toLocaleString()}ì›`
                                }
                            }
                        }
                    }
                });
            }

            function renderRightChart(keywords, amounts) {
                if (rightChart) rightChart.destroy();
                rightChart = new Chart(rightCtx, {
                    type: 'bar',
                    data: {
                        labels: keywords,
                        datasets: [{
                            label: 'í‚¤ì›Œë“œ ì†Œë¹„',
                            data: amounts,
                            backgroundColor: '#3340cb'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: ctx => `${ctx.raw.toLocaleString()}ì›`
                                }
                            }
                        }
                    }
                });
            }

            // ì´ˆê¸° ë¡œë”©
            fetch("/api/insite/spending-summary")
                .then(res => res.json())
                .then(data => {
                    const months = data.monthlyDateDtoList.map(item => item.whatMonth);
                    const amounts = data.monthlyDateDtoList.map(item => item.totalAmount);
                    renderLeftChart(months, amounts);

                    // 1. ê¸ˆì•¡ì„ í‘œì‹œí•  <p> íƒœê·¸ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
                    const totalAmountEl = document.getElementById("amount-of-this-month");

                    // 2. amounts ë°°ì—´ì— ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
                    if (totalAmountEl && amounts && amounts.length > 0) {
                        // 3. ë°°ì—´ì˜ ë§ˆì§€ë§‰ ê°’(ì´ë²ˆ ë‹¬ ì´ ì§€ì¶œ)ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
                        const lastAmount = amounts[amounts.length - 1];

                        myAverageMonthAmount = lastAmount;
                        // 4. p íƒœê·¸ì˜ í…ìŠ¤íŠ¸ë¥¼ í¬ë§·íŒ…í•˜ì—¬ ë³€ê²½í•©ë‹ˆë‹¤.
                        totalAmountEl.textContent = lastAmount.toLocaleString() + 'ì›';
                    }

                    // 1. ì´ë²ˆ ë‹¬ ì§€ì¶œì•¡(userSpending)ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
                    const userSpending = amounts.length > 0 ? amounts[amounts.length - 1] : 0;

                    // 2. HTMLì— ìˆ¨ê²¨ë‘” 'ë˜ë˜ í‰ê· ' ê°’ì„ ì½ì–´ì˜µë‹ˆë‹¤.
                    const averageAmountInput = document.getElementById('age-group-average-amount');
                    const averageAmount = parseFloat(averageAmountInput.value);

                    // 3. ê²°ê³¼ë¥¼ í‘œì‹œí•  <p> íƒœê·¸ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
                    const resultEl = document.getElementById('spending-comparison-result');

                    const compareAmount = Math.abs(userSpending - averageAmount);

                    // 4. ë‘ ê°’ì„ ë¹„êµí•˜ì—¬ ì ì ˆí•œ í…ìŠ¤íŠ¸ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
                    if (userSpending > averageAmount) {
                        resultEl.textContent = `ë˜ë˜ë³´ë‹¤ ${compareAmount}ì› ë” ë§ì´ ì“°ê³  ìˆì–´ìš” ğŸ’¸`;
                    }
                    if (userSpending < averageAmount)
                    {
                        resultEl.textContent = `ë˜ë˜ë³´ë‹¤ ${compareAmount} ì› ì ˆì•½í•˜ê³  ìˆì–´ìš” ğŸ‘`;
                    }
                    if (userSpending === averageAmount){
                        resultEl.textContent = `ë˜ë˜ë“¤ê³¼ ë¹„ìŠ·í•˜ê²Œ ì†Œë¹„í•˜ê³  ìˆì–´ìš” ğŸ‘`
                    }

                });

            // ì˜¤ë¥¸ìª½ ê·¸ë˜í”„ ë¡œë”©
            fetch("/api/insite/keyword-monthly")
                .then(res => res.json())
                .then(data => {
                    const currentMonth = new Date().getMonth() + 1;
                    const keywords = data.map(item => item.keyword);
                    const amounts = data.map(item => item.monthlyAmount[currentMonth - 1]);
                    renderRightChart(keywords, amounts);

                    // ğŸ”¹ í‚¤ì›Œë“œ ë²„íŠ¼ ë™ì  ìƒì„±
                    const box = document.querySelector('.keyword-btn-box');
                    data.forEach(item => {
                        const btn = document.createElement("button");
                        btn.textContent = item.keyword;
                        btn.onclick = () => {
                            renderLeftChart(
                                ["2ì›”", "3ì›”", "4ì›”", "5ì›”", "6ì›”", "7ì›”"],
                                item.monthlyAmount
                            );
                        };
                        box.appendChild(btn);
                    });
                });

            const monthText = document.getElementById("monthText");
            const calendarIcon = document.getElementById("calendarIcon");
            const dateInput = document.getElementById("datepicker");
            let currentDate = new Date(2025, 5); // 2025ë…„ 6ì›” (0-indexed)

            // ë°ì´í„°ë¥¼ ë‹¤ì‹œ ë¡œë“œí•˜ëŠ” í•¨ìˆ˜ë¥¼ ìƒˆë¡œ ë§Œë“¦
            function reloadDataForDate(date) {
                const year = date.getFullYear();
                const month = date.getMonth() + 1;

                // ì™¼ìª½ ê·¸ë˜í”„ ë°ì´í„° ë‹¤ì‹œ fetch
                fetch(`/api/insite/spending-summary?year=${year}&month=${month}`) // <-- APIê°€ ì—°/ì›” íŒŒë¼ë¯¸í„°ë¥¼ ë°›ì•„ì•¼ í•¨
                    .then(res => res.json())
                    .then(data => { /* ... ì°¨íŠ¸ ë‹¤ì‹œ ê·¸ë¦¬ê¸° ... */
                    });

                // ì˜¤ë¥¸ìª½ ê·¸ë˜í”„ ë°ì´í„°ë„ ë‹¤ì‹œ fetch
                fetch(`/api/insite/keyword-monthly?year=${year}&month=${month}`)
                    .then(res => res.json())
                    .then(data => { /* ... ì°¨íŠ¸ ë‹¤ì‹œ ê·¸ë¦¬ê¸° ... */
                    });
            }

            function updateMonthText() {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth() + 1;
                monthText.textContent = `${year}ë…„ ${month}ì›”`;
            }

            document.getElementById("prevMonth").onclick = () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                updateMonthText();
                reloadDataForDate(currentDate);
            };

            document.getElementById("nextMonth").onclick = () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                updateMonthText();
                reloadDataForDate(currentDate);
            };

            flatpickr("#datepicker", {
                dateFormat: "Y-m-d",
                defaultDate: currentDate,
                onChange: function (selectedDates) {
                    if (selectedDates.length > 0) {
                        currentDate = selectedDates[0];
                        updateMonthText();
                    }
                },
            });

            calendarIcon.onclick = () => {
                dateInput._flatpickr.open();
            };
            updateMonthText();

        });

        // ì´ ì†Œë¹„ë‚´ì—­ ì¶œë ¥í•˜ê¸°
        function renderLeftChart(months, amounts) {
            if (leftChart) leftChart.destroy();

            // âœ… í•©ê³„ ê³„ì‚°
            const total = amounts.reduce((sum, val) => sum + val, 0);
            // âœ… DOMì— ë°˜ì˜
            document.getElementById('leftTotalAmount').innerText = `${total.toLocaleString()}ì›`;
            document.getElementById('amount-of-this-month').innerText = `${amounts[amounts.length - 1].toLocaleString()}ì›`;

            leftChart = new Chart(leftCtx, {
                type: 'bar',
                data: {
                    labels: months.map(m => `${m}ì›”`),
                    datasets: [{
                        label: 'ì´ ì†Œë¹„',
                        data: amounts,
                        backgroundColor: '#3340cb'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: ctx => `${ctx.raw.toLocaleString()}ì›`
                            }
                        }
                    }
                }
            });
        }

        // ì˜¤ë¥¸ìª½ ê·¸ë˜í”„ ì´ ì§€ì¶œ ì¶œë ¥
        function renderRightChart(keywords, amounts) {
            if (rightChart) rightChart.destroy();

            // âœ… í•©ê³„ ê³„ì‚°
            const total = amounts.reduce((sum, val) => sum + val, 0);
            // âœ… DOMì— ë°˜ì˜
            document.getElementById('rightTotalAmount').innerText = `${total.toLocaleString()}ì›`;

            rightChart = new Chart(rightCtx, {
                type: 'bar',
                data: {
                    labels: keywords,
                    datasets: [{
                        label: 'í‚¤ì›Œë“œ ì†Œë¹„',
                        data: amounts,
                        backgroundColor: '#3340cb'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: ctx => `${ctx.raw.toLocaleString()}ì›`
                            }
                        }
                    }
                }
            });
        }

        document.querySelector(".export-button").addEventListener("click", () => {
            window.location.href = "/insite/export-pdf";
        });

        // btn.onclick = () => {
        //     renderLeftChart(
        //         ["2ì›”", "3ì›”", "4ì›”", "5ì›”", "6ì›”", "7ì›”"],
        //         item.monthlyAmount
        //     );
        // };




    </script>

</th:block>

<div  layout:fragment="content">
    <div class="container">
        <!-- íƒ€ì´í‹€ -->
        <div class="insight-header">
            <!-- ì¢Œì¸¡ íƒ€ì´í‹€ -->
            <div class="insight-title">
                <div class="dot"></div>
                <span>ì¸ì‚¬ì´íŠ¸</span>
            </div>

            <!-- ìš°ì¸¡ ë‚ ì§œ ì„ íƒ ë° ë²„íŠ¼ -->
            <div class="date-controls">
                <!-- ë‹¬ë ¥ ì•„ì´ì½˜ -->
<!--                <span class="calendar-icon" id="calendarIcon">ğŸ“…</span>-->

                <!-- ì›” ì´ë™ í‘œì‹œ -->
                <div class="month-display">
                    <button id="prevMonth">â—€</button>
                    <span id="monthText">2025ë…„ 6ì›”</span>
                    <button id="nextMonth">â–¶</button>
                </div>

                <!-- ë‚´ë³´ë‚´ê¸° -->
                <button class="export-button" onclick="window.location.href='/insite/export-pdf'">ë‚´ë³´ë‚´ê¸°</button>
            </div>
        </div>
        <!-- íƒ€ì´í‹€ -->

        <!-- ë‹¬ë ¥ íŒì—…ìš© -->
<!--        <input type="text" id="datepicker" />-->

        <!-- ì†Œë¹„ë‚´ì—­ -->
        <div class="sub-contatiner">
            <div class="consump">
                <div class="left-consump">
                    <p>ì›”ê°„ ì†Œë¹„ë‚´ì—­ ê·¸ë˜í”„</p>
                    <div class="consump-graph-box">
<!--                        <img src="images/consump-img.png" alt="ì´ë¯¸ì§€">-->
                        <p class="consump-amount" id="leftTotalAmount">
                            1,200,000ì›</p>
                        <canvas class="consump-graph-content" id="barChartLeft"></canvas>
                    </div>
                    <div class="keyword-btn-box">
                    </div>
                </div>
                <div class="right-consump">
                    <p>6ì›” ì†Œë¹„ë‚´ì—­</p>
                    <div class="month-graph-box">
                        <p id="rightTotalAmount">1,200,000ì›</p>
                        <canvas class="consump-graph-content-2" id="barChartRight"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <!-- ë‚˜/í‰ê·  ì—°ë ¹ëŒ€ ë³„ ì†Œë¹„ê¸ˆì•¡ ë¹„êµ -->
        <div class="foot-consump-box">
            <div class="foot-box">
                <!-- ì™¼ìª½: í”„ë¡œí•„ ë° ì•ˆë‚´ ë¬¸êµ¬ -->
                <div class="foot-text-box">
                    <div class="f-profile-photo">
                        <img src="images/foot-title-img.png">
                    </div>
                    <div class="foot-title">
                        <p th:text="${memberName} + 'ë‹˜,'"></p>
                        <p th:text="${ageGroupAverageDto.getAgeGroup()} + 'ë“¤ì˜'"></p>
                        <p>ì§€ë‚œ ë‹¬ í‰ê·  ì‚¬ìš© ì†Œë¹„ê¸ˆì•¡ì…ë‹ˆë‹¤.</p>
                    </div>
                </div>
                <!-- ì˜¤ë¥¸ìª½: ìˆ«ì ì˜ì—­ -->
                <div class="foot-right-consump-box">
                    <!-- ìƒë‹¨: ì—°ë ¹ëŒ€ í‰ê·  í‘œì‹œ -->
                    <div class="top-consump-box">
                        <span th:text="'ì§€ë‚œ ë‹¬ ' + ${ageGroupAverageDto.getAgeGroup()} + ' í•œ ë‹¬ ì‚¬ìš© ì†Œë¹„ê¸ˆì•¡  '"></span>
                        <span class="top-c-text" style="color: #3340cb;" th:text=
                              "${ageGroupAverageDto.getAverageAmount()} + 'ì›'"
                        ></span>
                    </div>
                    <!-- í•˜ë‹¨: ë³¸ì¸ ì†Œë¹„, ì°¨ì´ -->
                    <div class="l-r-box">
                        <div class="left-consump-box">
                            <p class="left-consump-text-1" th:text="${memberName} + 'ë‹˜ì˜ ì´ë²ˆ ë‹¬ ì†Œë¹„ê¸ˆì•¡'"></p>
                            <p class="left-consump-text-2" id="amount-of-this-month">ì›</p>
                            <button class="left-consump-text-btn">ê°€ê³„ë¶€ ë°”ë¡œê°€ê¸°</button>
                        </div>
                        <!-- ì°¨ì´ -->
                        <div class="right-consump-box">
                            <div class="r-consump-sub-box">
                                <div class="profile-photo" style="margin-bottom: 10px; margin-top: 20px;">
                                    <img src="images/r-consump-text.png" alt="ì´ë¯¸ì§€">
                                </div>
                                <input type="hidden" id="age-group-average-amount" th:value="${ageGroupAverageDto.getAverageAmount()}"/>
                                <p class="r-consump-text" id="spending-comparison-result"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- ë‚˜/í‰ê·  ì—°ë ¹ëŒ€ ë³„ ì†Œë¹„ê¸ˆì•¡ ë¹„êµ -->
    </div>
</div>

</html>