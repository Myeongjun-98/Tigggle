<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/defaultLayout}">

<th:block layout:fragment="css"><link rel="stylesheet" href="/css/insite/insite.css" /></th:block>
<th:block layout:fragment="script">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const leftCtx = document.getElementById('barChartLeft').getContext('2d');
        const rightCtx = document.getElementById('barChartRight').getContext('2d');

        let leftChart;
        let rightChart;

        function renderLeftChart(months, amounts) {
            if (leftChart) leftChart.destroy();
            leftChart = new Chart(leftCtx, {
                type: 'bar',
                data: {
                    labels: months.map(m => `${m}월`),
                    datasets: [{
                        label: '총 소비',
                        data: amounts,
                        backgroundColor: '#3340cb'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: ctx => `${ctx.raw.toLocaleString()}원`
                            }
                        }
                    }
                }
            });
        }

        function renderRightChart(keywords, amounts) {
            if (rightChart) rightChart.destroy();
            rightChart = new Chart(rightCtx, {
                type: 'bar',
                data: {
                    labels: keywords,
                    datasets: [{
                        label: '키워드 소비',
                        data: amounts,
                        backgroundColor: '#3340cb'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: ctx => `${ctx.raw.toLocaleString()}원`
                            }
                        }
                    }
                }
            });
        }

        // 초기 로딩
        fetch("/api/insite/spending-summary")
            .then(res => res.json())
            .then(data => {
                const months = data.monthlyDateDtoList.map(item => item.whatMonth);
                const amounts = data.monthlyDateDtoList.map(item => item.totalAmount);
                renderLeftChart(months, amounts);
            });

        // 오른쪽 그래프 로딩
        fetch("/api/insite/keyword-monthly")
            .then(res => res.json())
            .then(data => {
                const currentMonth = new Date().getMonth() + 1;
                const keywords = data.map(item => item.keyword);
                const amounts = data.map(item => item.monthlyAmount[currentMonth - 1]);
                renderRightChart(keywords, amounts);

                // 🔹 키워드 버튼 동적 생성
                const box = document.querySelector('.keyword-btn-box');
                data.forEach(item => {
                    const btn = document.createElement("button");
                    btn.textContent = item.keyword;
                    btn.onclick = () => {
                        renderLeftChart(
                            ["2월", "3월", "4월", "5월", "6월", "7월"],
                            item.monthlyAmount
                        );
                    };
                    box.appendChild(btn);
                });
            });
    </script>
</th:block>

<div  layout:fragment="content">
    <div class="container">
        <!-- 타이틀 -->
        <div class="insight-header">
            <!-- 좌측 타이틀 -->
            <div class="insight-title">
                <div class="dot"></div>
                <span>인사이트</span>
            </div>

            <!-- 우측 날짜 선택 및 버튼 -->
            <div class="date-controls">
                <!-- 달력 아이콘 -->
                <span class="calendar-icon" id="calendarIcon">📅</span>

                <!-- 월 이동 표시 -->
                <div class="month-display">
                    <button id="prevMonth">◀</button>
                    <span id="monthText">2025년 6월</span>
                    <button id="nextMonth">▶</button>
                </div>

                <!-- 내보내기 -->
                <button class="export-button">내보내기</button>
            </div>
        </div>

        <!-- 달력 팝업용 -->
        <input type="text" id="datepicker" />

        <!-- 소비내역 -->
        <div class="sub-contatiner">
            <div class="consump">
                <div class="left-consump">
                    <p>월간 소비내역 그래프</p>
                    <div class="consump-graph-box">
                        <span>1,200,000원</span>
                        <canvas id="monthlyChart"></canvas>
                    </div>
                    <div class="keyword-btn-box">
                        <button>키워드</button>
                        <button>키워드</button>
                        <button>키워드</button>
                        <button>키워드</button>
                    </div>
                </div>
                <div class="right-consump">
                    <p>6월 소비내역</p>
                    <div class="month-graph-box">
                        <canvas id="barChartRight"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="foot-consump-box">
            <div class="foot-box">
                <div class="foot-text-box">
                    <div class="profile-photo"></div>
                    <div class="foot-title">
                        <p>신선우님</p>
                        <p>20~30대들의</p>
                        <p>한달 평균 사용소비내역 입니다.</p>
                    </div>
                </div>
                <div class="foot-right-consump-box">
                    <div class="top-consump-box"></div>
                    <div class="l-r-box">
                        <div class="left-consump-box"></div>
                        <div class="right-consump-box"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const monthText = document.getElementById("monthText");
        const calendarIcon = document.getElementById("calendarIcon");
        const dateInput = document.getElementById("datepicker");
        let currentDate = new Date(2025, 5); // 2025년 6월 (0-indexed)

        function updateMonthText() {
          const year = currentDate.getFullYear();
          const month = currentDate.getMonth() + 1;
          monthText.textContent = `${year}년 ${month}월`;
        }

        document.getElementById("prevMonth").onclick = () => {
          currentDate.setMonth(currentDate.getMonth() - 1);
          updateMonthText();
        };

        document.getElementById("nextMonth").onclick = () => {
          currentDate.setMonth(currentDate.getMonth() + 1);
          updateMonthText();
        };

        flatpickr("#datepicker", {
          dateFormat: "Y-m-d",
          defaultDate: currentDate,
          onChange: function (selectedDates) {
            if (selectedDates.length > 0) {
              currentDate = selectedDates[0];
              updateMonthText();
            }
          },
        });

        calendarIcon.onclick = () => {
          dateInput._flatpickr.open();
        };

        updateMonthText();
    </script>

</html>